summarise(Count = n(), .groups = "drop_last") %>%
mutate(Percent = round(100 * Count / sum(Count), 1)) %>%
ungroup()
tbl_num <- dat %>%
group_by(Diabetes_012) %>%
summarise(
n        = n(),
Age_mean = mean(Age, na.rm = TRUE),
Age_sd   = sd(Age, na.rm = TRUE),
BMI_mean = mean(BMI, na.rm = TRUE),
BMI_sd   = sd(BMI, na.rm = TRUE),
.groups = "drop"
)
kable(tbl_num, caption = "Table 1a. Numeric variables by diabetes status")
# ä»¥ Sex ä¸ºä¾‹ï¼ˆå¯æŒ‰éœ€æ¢æˆ PhysActivity/Smoker/HighBP ç­‰ï¼‰
tbl_sex <- dat %>%
count(Diabetes_012, Sex, name = "Count") %>%
group_by(Diabetes_012) %>%
mutate(Percent = round(100 * Count / sum(Count), 1)) %>%
ungroup()
kable(tbl_sex, caption = "Table 1b. Distribution of Sex by diabetes status (count & %)")
# å†ç»™ä¸€ä¸ª PhysActivity ç¤ºä¾‹
tbl_pa <- dat %>%
count(Diabetes_012, PhysActivity, name = "Count") %>%
group_by(Diabetes_012) %>%
mutate(Percent = round(100 * Count / sum(Count), 1)) %>%
ungroup()
kable(tbl_pa, caption = "Supplementary: PhysActivity by diabetes status (count & %)")
# è®¡ç®—æ¯ä¸ª BMI ç±»åˆ«ä¸­â€œDiabetesâ€æ‰€å æ¯”ä¾‹
prev_bmi <- dat %>%
filter(!is.na(BMI_cat)) %>%
mutate(diabetes_binary = as.integer(Diabetes_012 == "Diabetes")) %>%
group_by(BMI_cat) %>%
summarise(prevalence = mean(diabetes_binary, na.rm = TRUE), .groups = "drop")
# æ³¨æ„ï¼šæŠŠå›¾å¯¹è±¡æ”¾åœ¨æœ€åä¸€è¡Œï¼Œç¡®ä¿æ¸²æŸ“å‡ºæ¥
ggplot(prev_bmi, aes(x = BMI_cat, y = prevalence)) +
geom_col() +
geom_text(aes(label = scales::percent(prevalence, accuracy = 0.1)), vjust = -0.25) +
labs(title = "Figure 1. Diabetes prevalence by BMI category",
x = "BMI Category", y = "Prevalence") +
ylim(0, 1)
dat$Diabetes_012 <- factor(dat$Diabetes_012,
levels = c("No/gestational only","Prediabetes","Diabetes"))
dat$PhysActivity <- if (!is.factor(dat$PhysActivity)) factor(dat$PhysActivity, levels = c(0,1), labels = c("No","Yes")) else dat$PhysActivity
dat$HighBP       <- if (!is.factor(dat$HighBP))       factor(dat$HighBP,       levels = c(0,1), labels = c("No","Yes")) else dat$HighBP
dat$Diabetes_012 <- factor(dat$Diabetes_012,
levels = c("No/gestational only","Prediabetes","Diabetes"))
dat$PhysActivity <- if (!is.factor(dat$PhysActivity)) factor(dat$PhysActivity, levels = c(0,1), labels = c("No","Yes")) else dat$PhysActivity
dat$HighBP       <- if (!is.factor(dat$HighBP))       factor(dat$HighBP,       levels = c(0,1), labels = c("No","Yes")) else dat$HighBP
# This step is for what:
tbl_ei <- dat %>%
count(Diabetes_012, Education, Income, name = "Count") %>%
group_by(Diabetes_012) %>%
mutate(Percent_in_group = round(100 * Count / sum(Count), 1)) %>%
ungroup()
kable(tbl_ei, caption = "Table 1. Education Ã— Income Ã— Diabetes (counts and % within Diabetes group)")
# This step is for what:
# å°† BRFSS çš„ Age ç±»åˆ«æ˜ å°„ä¸ºå¯è¯»åˆ†ç»„ï¼Œè®¡ç®—æ¯ä¸ªå¹´é¾„ç»„ä¸­â€œDiabetesâ€çš„æ¯”ä¾‹å¹¶å¯è§†åŒ–ï¼Œ
# ç›´è§‚å±•ç¤ºå¹´é¾„ä¸ç³–å°¿ç—…çš„å…³ç³»ï¼Œæ»¡è¶³ rubric çš„â€œcreate some figure + include text describing the figureâ€ã€‚
# BRFSS Age ç¼–ç å¸¸è§æ˜ å°„ï¼ˆ1=18â€“24, 2=25â€“29, â€¦, 13=80+ï¼‰
age_labs <- c("18â€“24","25â€“29","30â€“34","35â€“39","40â€“44","45â€“49",
"50â€“54","55â€“59","60â€“64","65â€“69","70â€“74","75â€“79","80+")
dat$AgeGrp <- factor(dat$Age, levels = 1:13, labels = age_labs)
prev_age <- dat %>%
mutate(diabetes_binary = as.integer(Diabetes_012 == "Diabetes")) %>%
group_by(AgeGrp) %>%
summarise(prevalence = mean(diabetes_binary, na.rm = TRUE),
n = n(), .groups = "drop")
ggplot(prev_age, aes(x = AgeGrp, y = prevalence)) +
geom_col() +
geom_text(aes(label = paste0(round(prevalence*100, 1), "%")), vjust = -0.25) +
labs(title = "Figure 1. Diabetes prevalence by age group",
x = "Age group", y = "Prevalence") +
ylim(0, 1)
# This step is for what:
# æ‹Ÿåˆä¸€ä¸ªå¯è§£é‡Šçš„äºŒåˆ†ç±»é€»è¾‘å›å½’æ¨¡å‹ï¼Œè¯„ä¼° Ageã€BMIã€Physical Activityã€HighBP ä¸ç³–å°¿ç—…(æ˜¯/å¦)çš„å…³è”å¼ºåº¦ã€‚
# å°†ä¸‰åˆ†ç±»åˆå¹¶ä¸ºäºŒåˆ†ç±»ï¼šDiabetes vs (No + Prediabetes)
dat$diabetes_bin <- as.integer(dat$Diabetes_012 == "Diabetes")  # 1 = Diabetes, 0 = otherwise
# æ‹Ÿåˆæ¨¡å‹ï¼ˆæ³¨æ„ï¼šPhysActivityã€HighBP å·²è½¬ä¸ºå› å­ï¼Œä¸Šå¼è‡ªåŠ¨åšæŒ‡ç¤ºå˜é‡ï¼‰
fit <- glm(diabetes_bin ~ Age + BMI + PhysActivity + HighBP,
data = dat, family = binomial())
# æå– ORï¼ˆe^coefï¼‰åŠåŸºäºæ ‡å‡†è¯¯çš„ 95% Wald CIï¼Œä¿æŒæœ€å°‘ä¾èµ–
coefs <- summary(fit)$coefficients
OR    <- exp(coefs[, "Estimate"])
SE    <- coefs[, "Std. Error"]
lower <- exp(coefs[, "Estimate"] - 1.96*SE)
upper <- exp(coefs[, "Estimate"] + 1.96*SE)
out   <- data.frame(Variable = rownames(coefs),
OR = round(OR, 3),
CI_lower = round(lower, 3),
CI_upper = round(upper, 3),
p_value = signif(coefs[, "Pr(>|z|)"], 3),
row.names = NULL)
kable(out, caption = "Logistic regression: Odds ratios for Diabetes (vs No/Prediabetes)")
library(readr)
raw<- read_csv("diabetes_012_health_indicators_BRFSS2015.csv")
dat$Diabetes_012 <- factor(dat$Diabetes_012,
levels = c(0,1,2),
labels = c("No/gestational only","Prediabetes","Diabetes"))
dat$Sex <- factor(dat$Sex, levels = c(0,1), labels = c("Female","Male"))
dat$Smoker <- factor(dat$Smoker, levels = c(0,1), labels = c("No","Yes"))
dat$PhysActivity <- factor(dat$PhysActivity, levels = c(0,1), labels = c("No","Yes"))
# BMI categorize
dat$BMI_cat <- cut(dat$BMI,
breaks = c(-Inf, 18.5, 25, 30, Inf),
labels = c("Underweight (<18.5)",
"Normal (18.5â€“24.9)",
"Overweight (25â€“29.9)",
"Obese (â‰¥30)"))
#check the structure
str(dat)
# This step is for what:
# Create a three-way cross-tabulation (Education Ã— Income Ã— Diabetes),
# showing counts and within-diabetes-group percentages.
# This serves as the core descriptive table and satisfies the rubric
# requirement to "create some table" and "include text describing the table."
dat$Diabetes_012 <- factor(dat$Diabetes_012,
levels = c("No/gestational only","Prediabetes","Diabetes"))
dat$PhysActivity <- if (!is.factor(dat$PhysActivity)) factor(dat$PhysActivity, levels = c(0,1), labels = c("No","Yes")) else dat$PhysActivity
dat$HighBP       <- if (!is.factor(dat$HighBP))       factor(dat$HighBP,       levels = c(0,1), labels = c("No","Yes")) else dat$HighBP
# This step is for what:
tbl_ei <- dat %>%
count(Diabetes_012, Education, Income, name = "Count") %>%
group_by(Diabetes_012) %>%
mutate(Percent_in_group = round(100 * Count / sum(Count), 1)) %>%
ungroup()
kable(tbl_ei, caption = "Table 1. Education Ã— Income Ã— Diabetes (counts and % within Diabetes group)")
# This step is for what:
# Map the BRFSS Age codes to readable age groups, compute the proportion
# of respondents with Diabetes in each age group, and visualize it.
# This satisfies the rubric requirement to "create some figure" and
# "include text describing the figure."
age_labs <- c("18â€“24","25â€“29","30â€“34","35â€“39","40â€“44","45â€“49",
"50â€“54","55â€“59","60â€“64","65â€“69","70â€“74","75â€“79","80+")
dat$AgeGrp <- factor(dat$Age, levels = 1:13, labels = age_labs)
prev_age <- dat %>%
mutate(diabetes_binary = as.integer(Diabetes_012 == "Diabetes")) %>%
group_by(AgeGrp) %>%
summarise(prevalence = mean(diabetes_binary, na.rm = TRUE),
n = n(), .groups = "drop")
ggplot(prev_age, aes(x = AgeGrp, y = prevalence)) +
geom_col() +
geom_text(aes(label = paste0(round(prevalence*100, 1), "%")), vjust = -0.25) +
labs(title = "Figure 1. Diabetes prevalence by age group",
x = "Age group", y = "Prevalence") +
ylim(0, 1)
library(readr)
raw<- read_csv("diabetes_012_health_indicators_BRFSS2015.csv")
# This step is for what:
# Create a three-way cross-tabulation (Education Ã— Income Ã— Diabetes),
# showing counts and within-diabetes-group percentages.
# This serves as the core descriptive table and satisfies the rubric
# requirement to "create some table" and "include text describing the table."
dat$Diabetes_012 <- factor(dat$Diabetes_012,
levels = c("No/gestational only","Prediabetes","Diabetes"))
dat$PhysActivity <- if (!is.factor(dat$PhysActivity)) factor(dat$PhysActivity, levels = c(0,1), labels = c("No","Yes")) else dat$PhysActivity
dat$HighBP       <- if (!is.factor(dat$HighBP))       factor(dat$HighBP,       levels = c(0,1), labels = c("No","Yes")) else dat$HighBP
# This step is for what:
tbl_ei <- dat %>%
count(Diabetes_012, Education, Income, name = "Count") %>%
group_by(Diabetes_012) %>%
mutate(Percent_in_group = round(100 * Count / sum(Count), 1)) %>%
ungroup()
kable(tbl_ei, caption = "Table 1. Education Ã— Income Ã— Diabetes (counts and % within Diabetes group)")
# This step is for what:
# Map the BRFSS Age codes to readable age groups, compute the proportion
# of respondents with Diabetes in each age group, and visualize it.
# This satisfies the rubric requirement to "create some figure" and
# "include text describing the figure."
age_labs <- c("18â€“24","25â€“29","30â€“34","35â€“39","40â€“44","45â€“49",
"50â€“54","55â€“59","60â€“64","65â€“69","70â€“74","75â€“79","80+")
dat$AgeGrp <- factor(dat$Age, levels = 1:13, labels = age_labs)
prev_age <- dat %>%
mutate(diabetes_binary = as.integer(Diabetes_012 == "Diabetes")) %>%
group_by(AgeGrp) %>%
summarise(prevalence = mean(diabetes_binary, na.rm = TRUE),
n = n(), .groups = "drop")
ggplot(prev_age, aes(x = AgeGrp, y = prevalence)) +
geom_col() +
geom_text(aes(label = paste0(round(prevalence*100, 1), "%")), vjust = -0.25) +
labs(title = "Figure 1. Diabetes prevalence by age group",
x = "Age group", y = "Prevalence") +
ylim(0, 1)
# This step is for what:
# Map the BRFSS Age codes to readable age groups, compute the proportion
# of respondents with Diabetes in each age group, and visualize it.
# This satisfies the rubric requirement to "create some figure" and
# "include text describing the figure."
age_labs <- c("18â€“24","25â€“29","30â€“34","35â€“39","40â€“44","45â€“49",
"50â€“54","55â€“59","60â€“64","65â€“69","70â€“74","75â€“79","80+")
dat$AgeGrp <- factor(dat$Age, levels = 1:13, labels = age_labs)
prev_age <- dat %>%
filter(!is.na(AgeGrp)) %>%
mutate(diabetes_binary = as.integer(Diabetes_012 == "Diabetes")) %>%
group_by(AgeGrp) %>%
summarise(prevalence = mean(diabetes_binary, na.rm = TRUE), .groups = "drop")
ggplot(prev_age, aes(x = AgeGrp, y = prevalence)) +
geom_col() +
geom_text(aes(label = scales::percent(prevalence, accuracy = 0.1)), vjust = -0.25) +
scale_y_continuous(limits = c(0, 1), labels = scales::percent) +  # ç”¨ scale_y_continuous æ›´ç¨³
labs(title = "Figure 1. Diabetes prevalence by age group",
x = "Age group", y = "Prevalence")
summary(prev_age)
knitr::opts_chunk$set(echo = TRUE)
import os
# è®¾ç½®æ–‡ä»¶å
file_name <- "diabetes_012_health_indicators_BRFSS2015.csv"
data_dir <- "data"
data_path <- file.path(data_dir, file_name)
# å¦‚æœ data æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œå°±åˆ›å»º
if (!dir.exists(data_dir)) {
dir.create(data_dir)
message("âœ… åˆ›å»ºäº† data æ–‡ä»¶å¤¹")
}
# å¦‚æœ CSV å·²ç»åœ¨ data/ é‡Œï¼Œç›´æ¥è¯»
if (file.exists(data_path)) {
df <- read.csv(data_path)
message("ğŸ“‚ æˆåŠŸä» data/ æ–‡ä»¶å¤¹è¯»å– CSV")
} else if (file.exists(file_name)) {
# å¦‚æœ CSV åœ¨æ ¹ç›®å½•ï¼Œå°±ç§»åŠ¨åˆ° data/ å†è¯»
file.rename(file_name, data_path)
df <- read.csv(data_path)
message("ğŸ”„ å·²å°† CSV ç§»åŠ¨åˆ° data/ æ–‡ä»¶å¤¹ï¼Œå¹¶æˆåŠŸè¯»å–")
} else {
stop("âŒ æ²¡æ‰¾åˆ° CSV æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥è·¯å¾„")
}
# çœ‹çœ‹æ•°æ®é¢„è§ˆ
head(df)
getwd()
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(readr)
library(dplyr)
library(ggplot2)
library(knitr)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(readr)
library(dplyr)
library(ggplot2)
library(knitr)
# Read CSV (put file at ./data/ or the project root)
data_file <- if (file.exists("data/diabetes_012_health_indicators_BRFSS2015.csv")) {
"data/diabetes_012_health_indicators_BRFSS2015.csv"
} else {
"diabetes_012_health_indicators_BRFSS2015.csv"
}
stopifnot(file.exists(data_file))  # stop if file missing
dat <- read_csv(data_file, show_col_types = FALSE)
# ---- Make key variables readable (idempotent) ----
# Diabetes_012 is numeric 0/1/2 in the CSV; convert to labeled factor
if (!is.factor(dat$Diabetes_012)) {
dat$Diabetes_012 <- factor(dat$Diabetes_012,
levels = c(0,1,2),
labels = c("No/gestational only","Prediabetes","Diabetes"))
}
# Binary indicators as factors
if (!is.factor(dat$PhysActivity)) dat$PhysActivity <- factor(dat$PhysActivity, levels = c(0,1), labels = c("No","Yes"))
if (!is.factor(dat$HighBP))       dat$HighBP       <- factor(dat$HighBP,       levels = c(0,1), labels = c("No","Yes"))
# Age groups from BRFSS codes 1..13 â†’ readable labels
age_labs <- c("18â€“24","25â€“29","30â€“34","35â€“39","40â€“44","45â€“49",
"50â€“54","55â€“59","60â€“64","65â€“69","70â€“74","75â€“79","80+")
dat$AgeGrp <- factor(dat$Age, levels = 1:13, labels = age_labs)
# Create a three-way cross-tabulation (Education Ã— Income Ã— Diabetes),
# showing counts and within-diabetes-group percentages.
tbl_ei <- dat %>%
count(Diabetes_012, Education, Income, name = "Count") %>%
group_by(Diabetes_012) %>%
mutate(Percent_in_group = round(100 * Count / sum(Count), 1)) %>%
ungroup()
kable(tbl_ei, caption = "Table 1. Education Ã— Income Ã— Diabetes (counts and % within Diabetes group)")
# Compute diabetes prevalence per age group and visualize
prev_age <- dat %>%
filter(!is.na(AgeGrp)) %>%
mutate(diabetes_binary = as.integer(Diabetes_012 == "Diabetes")) %>%
group_by(AgeGrp) %>%
summarise(prevalence = mean(diabetes_binary, na.rm = TRUE), .groups = "drop")
# Quick sanity check (should be 0..1, not all NA)
# print(summary(prev_age))
ggplot(prev_age, aes(x = AgeGrp, y = prevalence)) +
geom_col() +
geom_text(aes(label = scales::percent(prevalence, accuracy = 0.1)), vjust = -0.25) +
scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
labs(title = "Figure 1. Diabetes prevalence by age group",
x = "Age group", y = "Prevalence")
# Compute diabetes prevalence per age group and visualize
prev_age <- dat %>%
filter(!is.na(AgeGrp)) %>%
mutate(diabetes_binary = as.integer(Diabetes_012 == "Diabetes")) %>%
group_by(AgeGrp) %>%
summarise(prevalence = mean(diabetes_binary, na.rm = TRUE), .groups = "drop")
# Quick sanity check (should be 0..1, not all NA)
# print(summary(prev_age))
ggplot(prev_age, aes(x = AgeGrp, y = prevalence)) +
geom_col() +
geom_text(aes(label = scales::percent(prevalence, accuracy = 0.1)), vjust = -0.25) +
scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
labs(title = "Figure 1. Diabetes prevalence by age group",
x = "Age group", y = "Prevalence")
# Binary outcome: Diabetes vs (No/gestational only + Prediabetes)
dat$diabetes_bin <- as.integer(dat$Diabetes_012 == "Diabetes")  # 1 = Diabetes, 0 = otherwise
fit <- glm(diabetes_bin ~ Age + BMI + PhysActivity + HighBP,
data = dat, family = binomial())
coefs <- summary(fit)$coefficients
OR    <- exp(coefs[, "Estimate"])
SE    <- coefs[, "Std. Error"]
lower <- exp(coefs[, "Estimate"] - 1.96*SE)
upper <- exp(coefs[, "Estimate"] + 1.96*SE)
out <- data.frame(
Variable = rownames(coefs),
OR       = round(OR, 3),
CI_lower = round(lower, 3),
CI_upper = round(upper, 3),
p_value  = signif(coefs[, "Pr(>|z|)"], 3),
row.names = NULL
)
kable(out, caption = "Logistic regression: Odds ratios for Diabetes (vs No/Prediabetes)")
library(readr)
library(dplyr)
library(lme4)       # lmer
library(lmerTest)   # p-values for lmer
# è¯»å…¥å¹¶æ„é€  ageD / Read and create ageD
dat <- read_csv("CD4.csv") |>
mutate(
id    = factor(id),
ageD  = visage - baseage,
# ç¡®ä¿ treat æ˜¯ 0/1 æ•°å€¼ï¼Œä¾¿äºè§£é‡Šäº¤äº’ï¼›è‹¥å·²æ˜¯0/1å¯è·³è¿‡
treat = as.numeric(treat)
)
# è¯»å…¥å¹¶æ„é€  ageD / Read and create ageD
dat <- read_csv("CD4.csv") |>
mutate(
id    = factor(id),
ageD  = visage - baseage,
# ç¡®ä¿ treat æ˜¯ 0/1 æ•°å€¼ï¼Œä¾¿äºè§£é‡Šäº¤äº’ï¼›è‹¥å·²æ˜¯0/1å¯è·³è¿‡
treat = as.numeric(treat)
)
# å¿«é€Ÿæ£€æŸ¥ / quick check
summary(dat)
m <- lmer(cd4 ~ ageD * treat + (1 + ageD | id), data = dat, REML = TRUE)
fixef_tbl <- broom.mixed::tidy(m, effects = "fixed", conf.int = TRUE, conf.method = "Wald")
install.packages("lmerTest")
library(lmerTest)
m <- lmer(cd4 ~ ageD * treat + (1 + ageD | id), data = dat, REML = TRUE)
fixef_tbl <- broom.mixed::tidy(m, effects = "fixed", conf.int = TRUE, conf.method = "Wald")
library(broom.mixed)
install.packages("broom.mixed")
library(broom.mixed)
library(broom.mixed) # tidy + confint
library(emmeans)    # contrasts & slopes
install.packages("emmeans")
library(lmerTest)   # p-values for lmer
library(broom.mixed) # tidy + confint
library(emmeans)
m <- lmer(cd4 ~ ageD * treat + (1 + ageD | id), data = dat, REML = TRUE)
fixef_tbl <- broom.mixed::tidy(m, effects = "fixed", conf.int = TRUE, conf.method = "Wald")
fixef_tbl
# åŸºçº¿å·® (treated - untreated) at ageD = 0
rg0 <- ref_grid(m, at = list(ageD = 0))
baseline_contrast <- contrast(emmeans(rg0, ~ treat), method = "revpairwise")  # treated - untreated
summary(baseline_contrast, infer = c(TRUE, TRUE))
# ç»„å†…æ–œç‡ï¼šæœªæ²»ä¸å·²æ²» / Slopes by treatment
slopes <- emtrends(m, ~ treat, var = "ageD")
summary(slopes, infer = c(TRUE, TRUE))
# æ–œç‡å·®ï¼ˆtreated âˆ’ untreatedï¼‰
slope_diff <- contrast(slopes, method = "revpairwise")
summary(slope_diff, infer = c(TRUE, TRUE))
varcomp <- as.data.frame(VarCorr(m))  # åŒ…å«éšæœºæˆªè·/æ–œç‡æ–¹å·®ä¸ç›¸å…³
varcomp
res_var <- sigma(m)^2                 # æ®‹å·®æ–¹å·®
res_var
plot(m)          # æ®‹å·® vs æ‹Ÿåˆå€¼
qqnorm(residuals(m)); qqline(residuals(m))
# --- packages
library(dplyr); library(Matrix)
library(dplyr); library(Matrix)
# --- design: 4 sequences across 3 periods
seq_tbl <- tibble(
group = rep(LETTERS[1:4], each = 3),
period = rep(1:3, times = 4),
treat  = c(0,0,0,  0,0,1,  1,0,0,  1,0,1)  # A: P-W-P; B: P-W-T; C: T-W-P; D: T-W-T
)
# --- expand to 100 subjects (25 per group)
set.seed(1)
subj <- tibble(id = 1:100, group = rep(LETTERS[1:4], each = 25))
dat0 <- subj %>% left_join(seq_tbl, by="group") %>% arrange(id, period)
# --- covariance within subject: exchangeable (sigma^2=1, rho=0.40)
rho <- 0.40; sig2 <- 1
Vi <- matrix(rho, 3, 3); diag(Vi) <- 1
Vi_inv <- solve(Vi)                   # same for every subject
# block-diagonal V^{-1}
Vinv <- bdiag(replicate(100, as(Matrix(Vi_inv), "dgCMatrix"), simplify = FALSE))
# ----- Basic setup -----
rho <- 0.40
sigma2 <- 1
k <- qnorm(0.975) + qnorm(0.90)  # = 3.2416 for alpha=0.05, power=90%
# --- Build design matrix (100 subjects Ã— 3 periods)
id <- rep(1:100, each = 3)
group <- rep(rep(LETTERS[1:4], each = 75), length.out = 300)
period <- rep(1:3, times = 100)
treat <- c(0,0,0, 0,0,1, 1,0,0, 1,0,1)
group <- rep(LETTERS[1:4], each = 75)
df <- data.frame(id, group, period, treat = rep(treat, each = 25))
# --- Exchangeable covariance (3x3)
V <- matrix(rho, 3, 3); diag(V) <- 1
V.inv <- solve(V)
# --- Function to get SE(treatment)
get_se <- function(X) {
# For simplicity: 100 identical 3x3 blocks
XtVinvX <- 100 * crossprod(X, V.inv %*% X)
sqrt(solve(XtVinvX)[2,2])
}
# ----- Scenario 1: washout = placebo, no period effect -----
X1 <- cbind(1, df$treat)
se1 <- get_se(X1)
# ----- Scenario 2: drop washout after treatment (C, D groups period 2) -----
df2 <- subset(df, !(group %in% c("C","D") & period == 2))
X2 <- cbind(1, df2$treat)
n2 <- length(unique(df2$id))
XtVinvX2 <- n2 * crossprod(X2, V.inv[1:2,1:2] %*% X2[1:2,]) # approximate 2x2 block
# === Setup ===
rho <- 0.40
sigma2 <- 1
k <- qnorm(0.975) + qnorm(0.90)  # â‰ˆ 3.2416
# --- Build design (100 subjects Ã— 3 periods)
id <- rep(1:100, each = 3)
group <- rep(rep(LETTERS[1:4], each = 75), length.out = 300)
period <- rep(1:3, times = 100)
treat_seq <- c(0,0,0, 0,0,1, 1,0,0, 1,0,1)
group <- rep(LETTERS[1:4], each = 75)
treat <- rep(treat_seq, each = 25)
df <- data.frame(id, group, period, treat)
# --- Within-subject covariance (3x3)
V <- matrix(rho, 3, 3); diag(V) <- 1
Vinv <- solve(V)
# Helper function to compute SE for identical subjects
get_se <- function(X, nsubj, Vinv) {
XtVinvX <- crossprod(X, Vinv %*% X)
sqrt(solve(nsubj * XtVinvX)[2, 2])
}
# === Scenario 1: full data, no period effect ===
X1 <- cbind(1, c(0,0,0))  # only structure matters: 3 periods per subj
se1 <- get_se(X1, 100, Vinv)
# ========= Helper: exchangeable inverse =========
exch_inv <- function(m, rho) {
# V = (1-rho)I + rho J  =>  V^{-1} = a I + b J
# where a = 1/(1-rho),  b = -rho / ((1-rho)*(1-rho + m*rho))
a <- 1/(1 - rho)
b <- -rho / ((1 - rho) * (1 - rho + m*rho))
A <- diag(m) * a
A <- A + matrix(b, m, m)      # add bJ
A
}
# ========= Core function: add up per-sequence Fisher info =========
info_seq <- function(tvec, Vinv, add_period = FALSE, periods = NULL) {
# tvec : numeric vector of treatment (0/1) for the kept periods of that sequence
# Vinv : inverse covariance for those periods (m x m)
# add_period: whether to include period fixed effects (Per2, Per3)
# periods: the period indices kept for this sequence (e.g., c(1,3) if period 2 is dropped)
m <- length(tvec)
if (is.null(periods)) periods <- seq_len(m)
# Design: Intercept + Treatment (+ Period2 + Period3 if requested)
X <- cbind(Intercept = rep(1, m), Treat = tvec)
if (add_period) {
per2 <- as.numeric(periods == 2)
per3 <- as.numeric(periods == 3)
X <- cbind(X, Per2 = per2, Per3 = per3)
}
crossprod(X, Vinv %*% X)   # subject-level info
}
# ========= Parameters & common pieces =========
rho <- 0.40
n_total <- 100
n_per_group <- n_total / 4  # 25 per sequence
k <- qnorm(0.975) + qnorm(0.90)  # â‰ˆ 3.2416
Vinv3 <- exch_inv(3, rho)   # inverse for 3 periods
Vinv2 <- exch_inv(2, rho)   # inverse for 2 periods
# ========= Scenario 1: keep all, no period effects =========
# Sequences (Period1,2,3): A=0,0,0; B=0,0,1; C=1,0,0; D=1,0,1
I1 <- 0
I1 <- I1 + n_per_group * info_seq(c(0,0,0), Vinv3, add_period = FALSE)
I1 <- I1 + n_per_group * info_seq(c(0,0,1), Vinv3, add_period = FALSE)
I1 <- I1 + n_per_group * info_seq(c(1,0,0), Vinv3, add_period = FALSE)
I1 <- I1 + n_per_group * info_seq(c(1,0,1), Vinv3, add_period = FALSE)
Var1 <- solve(I1)
SE1  <- sqrt(Var1["Treat","Treat"])
MDE1 <- k * SE1
# ========= Scenario 2: drop washout right after treatment (C,D period 2) =========
# A,B keep all 3 periods; C: keep periods (1,3) with t = (1,0); D: keep (1,3) with t = (1,1)
I2 <- 0
I2 <- I2 + n_per_group * info_seq(c(0,0,0), Vinv3, add_period = FALSE)                # A
I2 <- I2 + n_per_group * info_seq(c(0,0,1), Vinv3, add_period = FALSE)                # B
I2 <- I2 + n_per_group * info_seq(c(1,0),    Vinv2, add_period = FALSE, periods=c(1,3)) # C (drop 2)
I2 <- I2 + n_per_group * info_seq(c(1,1),    Vinv2, add_period = FALSE, periods=c(1,3)) # D (drop 2)
Var2 <- solve(I2)
SE2  <- sqrt(Var2["Treat","Treat"])
MDE2 <- k * SE2
# ========= Scenario 3: add fixed period effects (on top of Scenario 2) =========
# Same kept rows as Scenario 2, but include Per2/Per3 columns
I3 <- 0
I3 <- I3 + n_per_group * info_seq(c(0,0,0), Vinv3, add_period = TRUE,  periods=c(1,2,3)) # A
I3 <- I3 + n_per_group * info_seq(c(0,0,1), Vinv3, add_period = TRUE,  periods=c(1,2,3)) # B
I3 <- I3 + n_per_group * info_seq(c(1,0),   Vinv2, add_period = TRUE,  periods=c(1,3))   # C
I3 <- I3 + n_per_group * info_seq(c(1,1),   Vinv2, add_period = TRUE,  periods=c(1,3))   # D
Var3 <- solve(I3)
SE3  <- sqrt(Var3["Treat","Treat"])
MDE3 <- k * SE3
# ========= Print clean results =========
round(c(SE1=SE1, SE2=SE2, SE3=SE3), 3)
round(c(MDE1=MDE1, MDE2=MDE2, MDE3=MDE3), 3)
renv::init()
setwd("~/Desktop/Data550_final")
getwd()
renv::init()
